<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <script src="https://unpkg.com/datocms-plugins-sdk"></script>
  <link href="https://unpkg.com/datocms-plugins-sdk/dist/sdk.css" media="all" rel="stylesheet" />
</head>
<body>
    <!-- <form>
        <select id="optionSelect" name="option_select">
        </select>
    </form> -->

    <div class="inputLine">
        <input id="itemInput" type="text" autocomplete="off" name="item_input" />
        <div id="selectWrapper" style="display: none;">
            <select id="optionSelect" name="option_select"></select>
            <i class="select-icon fas fa-lg fa-chevron-down"></i>
        </div>
        <button id="addItemButton" class="DatoCMS-button">Add</button>
    </div>



    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.11/lodash.min.js"></script>
    <script type="text/javascript">

    function deserializeValue(value) {
      if (!value) {
          return [];
      }
      return JSON.parse(value);
    }

    function getFieldValue(plugin) {
        var fieldValue = plugin.getFieldValue(plugin.fieldPath);
        return deserializeValue(fieldValue);
    }

    function setFieldValue(plugin, value) {
        return plugin.setFieldValue(plugin.fieldPath, JSON.stringify(value));
    }

    function getFieldType(plugin) {
      var type = _.get(plugin, 'parameters.instance.type', 'string');
      if (!_.includes(['string', 'number'], type)) {
          console.error('illegal type "' + type + '" for datocms-plugin-typed-list');
          return 'string';
      }
      return type;
    }
      
    function getOptions(plugin) {
        var type = getFieldType(plugin);
        if (type === 'string') {
            var options = _.get(plugin, 'parameters.instance.options', '');
            var optionsArr = _.chain(options).split(',').map(option => _.trim(option)).compact().value();
            return _.isEmpty(optionsArr) ? null : optionsArr;
        } else {
            return null;
        }
    }

    function showSelect(options, selectElm) {
        _.forEach([''].concat(options), option => {
            var optionElm = document.createElement('option');
            optionElm.name = option;
            optionElm.appendChild(document.createTextNode(option));
            selectElm.appendChild(optionElm);
        });
    }

    DatoCmsPlugin.init(function(plugin) {
      const type = getFieldType(plugin);
      const options = getOptions(plugin);
      const list = getFieldValue(plugin);
      const select = document.querySelector("#optionSelect");

      if (!_.isEmpty(options)) {
        showSelect(options, select);
      }

      if (type === 'number') {
        inputElm.type = 'number';
      }

      plugin.startAutoResizer()

      select.value = plugin.getFieldValue(plugin.fieldPath);

      plugin.addFieldChangeListener(plugin.fieldPath, function(newValue) {
        select.value = newValue;
      });

      select.addEventListener("change", function(e) {
        plugin.setFieldValue(plugin.fieldPath, "[" + JSON.stringify(e.target.value) + "]");
      });

      getFieldValue: () => list

    });
  </script>
</body>
</html>